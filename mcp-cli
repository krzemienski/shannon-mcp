#!/usr/bin/env bash
# mcp-cli - CLI wrapper for Shannon MCP server tools
# Auto-generated comprehensive wrapper for all MCP tools

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MCP_SERVER="${MCP_SERVER:-poetry run shannon-mcp}"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Helper function to call MCP server via stdio
call_mcp_tool() {
    local tool_name="$1"
    local args="$2"

    local request=$(cat <<EOF
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "${tool_name}",
    "arguments": ${args}
  }
}
EOF
)

    echo "${request}" | ${MCP_SERVER} 2>/dev/null | jq -r '.result.content[0].text // .error.message // .'
}

# Helper function to read MCP resource
call_mcp_resource() {
    local uri="$1"

    local request=$(cat <<EOF
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "resources/read",
  "params": {
    "uri": "${uri}"
  }
}
EOF
)

    echo "${request}" | ${MCP_SERVER} 2>/dev/null | jq -r '.result // .error.message // .'
}

# Helper function to list all tools
call_list_tools() {
    local request=$(cat <<EOF
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/list",
  "params": {}
}
EOF
)

    echo "${request}" | ${MCP_SERVER} 2>/dev/null | jq -r '.result.tools // .error.message // .'
}

#
# Tool implementations - one function per MCP tool
#

cmd_find_claude_binary() {
    echo -e "${YELLOW}Finding Claude Code binary...${NC}"
    call_mcp_tool "find_claude_binary" "{}"
}

cmd_create_session() {
    local prompt="$1"
    local model="${2:-claude-3-sonnet}"
    local checkpoint_id="${3:-}"

    local args="{\"prompt\": \"${prompt}\", \"model\": \"${model}\""

    if [[ -n "${checkpoint_id}" ]]; then
        args="${args}, \"checkpoint_id\": \"${checkpoint_id}\""
    fi

    args="${args}}"

    echo -e "${YELLOW}Creating session...${NC}"
    call_mcp_tool "create_session" "${args}"
}

cmd_send_message() {
    local session_id="$1"
    local content="$2"
    local timeout="${3:-}"

    local args="{\"session_id\": \"${session_id}\", \"content\": \"${content}\""

    if [[ -n "${timeout}" ]]; then
        args="${args}, \"timeout\": ${timeout}"
    fi

    args="${args}}"

    echo -e "${YELLOW}Sending message to session ${session_id}...${NC}"
    call_mcp_tool "send_message" "${args}"
}

cmd_cancel_session() {
    local session_id="$1"

    echo -e "${YELLOW}Canceling session ${session_id}...${NC}"
    call_mcp_tool "cancel_session" "{\"session_id\": \"${session_id}\"}"
}

cmd_list_sessions() {
    local state="${1:-}"
    local limit="${2:-100}"

    local args="{\"limit\": ${limit}"

    if [[ -n "${state}" ]]; then
        args="${args}, \"state\": \"${state}\""
    fi

    args="${args}}"

    echo -e "${YELLOW}Listing sessions...${NC}"
    call_mcp_tool "list_sessions" "${args}"
}

cmd_list_agents() {
    local category="${1:-}"
    local status="${2:-}"
    local capability="${3:-}"

    local args="{"
    local sep=""

    if [[ -n "${category}" ]]; then
        args="${args}\"category\": \"${category}\""
        sep=", "
    fi

    if [[ -n "${status}" ]]; then
        args="${args}${sep}\"status\": \"${status}\""
        sep=", "
    fi

    if [[ -n "${capability}" ]]; then
        args="${args}${sep}\"capability\": \"${capability}\""
    fi

    args="${args}}"

    echo -e "${YELLOW}Listing agents...${NC}"
    call_mcp_tool "list_agents" "${args}"
}

cmd_assign_task() {
    local description="$1"
    local required_capabilities="$2"  # JSON array string like '["python","testing"]'
    local priority="${3:-medium}"
    local timeout="${4:-}"

    local args="{\"description\": \"${description}\", \"required_capabilities\": ${required_capabilities}, \"priority\": \"${priority}\""

    if [[ -n "${timeout}" ]]; then
        args="${args}, \"timeout\": ${timeout}"
    fi

    args="${args}}"

    echo -e "${YELLOW}Assigning task...${NC}"
    call_mcp_tool "assign_task" "${args}"
}

#
# Resource implementations
#

cmd_get_config() {
    echo -e "${YELLOW}Getting configuration...${NC}"
    call_mcp_resource "shannon://config"
}

cmd_get_agents_resource() {
    echo -e "${YELLOW}Getting agents resource...${NC}"
    call_mcp_resource "shannon://agents"
}

cmd_get_sessions_resource() {
    echo -e "${YELLOW}Getting sessions resource...${NC}"
    call_mcp_resource "shannon://sessions"
}

#
# Utility commands
#

cmd_list_tools() {
    echo -e "${YELLOW}Listing all available tools...${NC}"
    call_list_tools
}

cmd_help() {
    cat <<EOF
${GREEN}Shannon MCP CLI - Command Line Interface for Shannon MCP Server${NC}

${YELLOW}USAGE:${NC}
    mcp-cli <command> [arguments]

${YELLOW}TOOLS:${NC}
    ${GREEN}find-claude-binary${NC}
        Discover Claude Code installation on the system
        Usage: mcp-cli find-claude-binary

    ${GREEN}create-session${NC} <prompt> [model] [checkpoint_id]
        Create a new Claude Code session
        Usage: mcp-cli create-session "Your prompt here" [claude-3-sonnet] [checkpoint-id]

    ${GREEN}send-message${NC} <session_id> <content> [timeout]
        Send a message to an active session
        Usage: mcp-cli send-message "sess-123" "Your message" [30]

    ${GREEN}cancel-session${NC} <session_id>
        Cancel a running session
        Usage: mcp-cli cancel-session "sess-123"

    ${GREEN}list-sessions${NC} [state] [limit]
        List active sessions
        Usage: mcp-cli list-sessions [active] [100]

    ${GREEN}list-agents${NC} [category] [status] [capability]
        List available AI agents
        Usage: mcp-cli list-agents [core] [available] [python]

    ${GREEN}assign-task${NC} <description> <capabilities_json> [priority] [timeout]
        Assign a task to an AI agent
        Usage: mcp-cli assign-task "Implement feature X" '["python","testing"]' [high] [300]

${YELLOW}RESOURCES:${NC}
    ${GREEN}get-config${NC}
        Get current configuration
        Usage: mcp-cli get-config

    ${GREEN}get-agents-resource${NC}
        Get agents resource (alternative to list-agents)
        Usage: mcp-cli get-agents-resource

    ${GREEN}get-sessions-resource${NC}
        Get sessions resource (alternative to list-sessions)
        Usage: mcp-cli get-sessions-resource

${YELLOW}UTILITY:${NC}
    ${GREEN}list-tools${NC}
        List all available MCP tools
        Usage: mcp-cli list-tools

    ${GREEN}help${NC}
        Show this help message
        Usage: mcp-cli help

${YELLOW}ENVIRONMENT VARIABLES:${NC}
    ${GREEN}MCP_SERVER${NC}
        Command to run the MCP server (default: poetry run shannon-mcp)

${YELLOW}EXAMPLES:${NC}
    # Find Claude Code binary
    mcp-cli find-claude-binary

    # Create a new session
    mcp-cli create-session "Fix the login bug"

    # List all sessions
    mcp-cli list-sessions

    # List agents with Python capability
    mcp-cli list-agents "" "" "python"

    # Assign a task to an agent
    mcp-cli assign-task "Write unit tests" '["python","testing"]' high

EOF
}

#
# Main command dispatcher
#

main() {
    local command="${1:-}"

    if [[ -z "$command" ]]; then
        cmd_help
        exit 1
    fi

    shift || true

    case "$command" in
        # Tools
        find-claude-binary)
            cmd_find_claude_binary "$@"
            ;;
        create-session)
            cmd_create_session "$@"
            ;;
        send-message)
            cmd_send_message "$@"
            ;;
        cancel-session)
            cmd_cancel_session "$@"
            ;;
        list-sessions)
            cmd_list_sessions "$@"
            ;;
        list-agents)
            cmd_list_agents "$@"
            ;;
        assign-task)
            cmd_assign_task "$@"
            ;;

        # Resources
        get-config)
            cmd_get_config "$@"
            ;;
        get-agents-resource)
            cmd_get_agents_resource "$@"
            ;;
        get-sessions-resource)
            cmd_get_sessions_resource "$@"
            ;;

        # Utility
        list-tools)
            cmd_list_tools "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;

        *)
            echo -e "${RED}Error: Unknown command '${command}'${NC}"
            echo "Run 'mcp-cli help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
